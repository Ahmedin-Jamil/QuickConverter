<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin | QC Deep Analytics</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="legal-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 0.5rem;
            color: #000;
        }

        .chart-container {
            background: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .activity-table th,
        .activity-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .activity-table th {
            background: #f9fafb;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .activity-table tr:last-child td {
            border-bottom: none;
        }

        .admin-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .geo-list {
            list-style: none;
            padding: 0;
        }

        .geo-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .geo-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body style="background-color: #f3f4f6; padding: 4rem;">
    <div style="max-width: 1200px; margin: 0 auto;">
        <nav class="admin-nav">
            <div>
                <h1 style="font-size: 1.5rem; font-weight: 800; color: #000;">Global Analytics</h1>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Advanced insights for q-convert.com</p>
            </div>
            <a href="/" class="btn-primary"
                style="padding: 0.6rem 1.2rem; font-size: 0.85rem; text-decoration: none;">Back to Dashboard</a>
        </nav>

        <!-- KPI Row -->
        <div class="admin-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Users</div>
                <div class="kpi-value" id="stat-users">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Pro Subscribers</div>
                <div class="kpi-value" id="stat-pro" style="color: var(--accent);">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Conversions</div>
                <div class="kpi-value" id="stat-conversions">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Global Click Events</div>
                <div class="kpi-value" id="stat-clicks">0</div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="chart-container">
                <h3 style="margin-bottom: 1.5rem; font-size: 1rem;">Primary Tool Usage Ranking</h3>
                <div style="height: 300px;"><canvas id="toolChart"></canvas></div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 1.5rem; font-size: 1rem;">Geographic Distribution</h3>
                <ul id="geo-list" class="geo-list">
                    <!-- Loaded JS -->
                </ul>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="chart-container">
                <h3 style="margin-bottom: 1.5rem; font-size: 1rem;">User Interface Click-Throughs</h3>
                <div style="height: 300px;"><canvas id="clickChart"></canvas></div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 1.5rem; font-size: 1rem;">Conversion Timeline</h3>
                <div style="height: 300px;"><canvas id="conversionChart"></canvas></div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem; font-size: 1rem;">Detailed Conversion Audit Trail</h3>
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tool Used</th>
                        <th>Location</th>
                        <th>Browser</th>
                        <th>Rows</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="activity-feed">
                    <!-- Loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadStats() {
            try {
                const response = await fetch('http://localhost:5000/admin/stats', {
                    headers: { 'X-Admin-Secret': 'qc_super_secret_admin_2026' }
                });
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                const s = data.summary;
                document.getElementById('stat-users').innerText = s.total_users;
                document.getElementById('stat-pro').innerText = s.pro_users;
                document.getElementById('stat-conversions').innerText = s.total_conversions;

                const totalClicks = Object.values(s.click_ranking).reduce((a, b) => a + b, 0);
                document.getElementById('stat-clicks').innerText = totalClicks.toLocaleString();

                renderCharts(data.trends, s);
                renderActivity(s.recent_conversions);
                renderGeo(s.geo_ranking);
            } catch (err) {
                console.error("Failed to load admin stats:", err);
            }
        }

        function renderCharts(trends, summary) {
            // Conversion Trends
            new Chart(document.getElementById('conversionChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: trends.map(t => new Date(t.created_at).toLocaleDateString()),
                    datasets: [{
                        label: 'Daily Volume',
                        data: trends.map((_, i) => i + 1),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Tool Usage Bar Chart
            const tools = Object.keys(summary.tool_ranking);
            new Chart(document.getElementById('toolChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: tools.map(t => t.replace(/_/g, ' ').toUpperCase()),
                    datasets: [{
                        label: 'Successful Conversions',
                        data: Object.values(summary.tool_ranking),
                        backgroundColor: '#10b981',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Click Rankings
            const clicks = Object.keys(summary.click_ranking).slice(0, 6);
            new Chart(document.getElementById('clickChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: clicks,
                    datasets: [{
                        data: clicks.map(c => summary.click_ranking[c]),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#6b7280']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderGeo(ranking) {
            const list = document.getElementById('geo-list');
            const countries = Object.keys(ranking).sort((a, b) => ranking[b] - ranking[a]);

            list.innerHTML = countries.slice(0, 5).map(c => `
                <li class="geo-item">
                    <span style="font-weight:600">${c === 'Local' ? 'üìç Development' : c}</span>
                    <span style="color:var(--text-muted)">${ranking[c]} sessions</span>
                </li>
            `).join('');
        }

        function renderActivity(recent) {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = recent.reverse().map(c => `
                <tr>
                    <td><span style="font-family: monospace; font-size: 0.8rem;">${c.user_email || 'Guest'}</span></td>
                    <td><span class="tier-tag pro-tier" style="font-size:0.7rem">${(c.tool_type || 'main').toUpperCase()}</span></td>
                    <td>${c.city || 'Unknown'}, ${c.country || ''}</td>
                    <td style="font-size:0.75rem; color:var(--text-muted)">${(c.browser || 'Chrome').substring(0, 20)}...</td>
                    <td>${c.total_rows}</td>
                    <td>${c.processing_time_ms.toFixed(0)}ms</td>
                </tr>
            `).join('');
        }

        loadStats();
    </script>
</body>

</html>